import React, { useState, useRef, useEffect } from "react";
import { useParams } from "react-router-dom";
import "bootstrap/dist/css/bootstrap.min.css";
import "bootstrap/dist/js/bootstrap.bundle.min";
import "../../resources/css/style.css";
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome";
import {
  faCapsules,
  faHeart,
  faStar,
} from "@fortawesome/free-solid-svg-icons";
import Chart from "chart.js/auto";
import { Col, Container, Row } from "react-bootstrap";
import image1 from "../../resources/image/product1.jpg";
import image2 from "../../resources/image/product2.jpg";
import image3 from "../../resources/image/product3.jpg";
import image4 from "../../resources/image/helfugarcinia.jpg";
import Button from "../common/Button";
import ReviewForm from "./ReviewForm"; // ğŸ“Œ ë¦¬ë·° ì‘ì„± ëª¨ë‹¬ ì¶”ê°€

//  ìƒí’ˆ ë°ì´í„° (API ì—°ë™ ì „ í…ŒìŠ¤íŠ¸ ë°ì´í„°)
const products = [
  {
    id: 1,
    name: "í”„ë ˆì‰¬ ìœ ì‚°ê· ",
    price: 22900,
    discount: 0.1,
    image: image3,
    thumbnails: [image3, image2, image1],
    description: "ì´ ì œí’ˆì€ ë©´ì—­ê³¼ ê±´ê°•ì„ ìœ„í•œ ìµœê³ ì˜ ì„ íƒì…ë‹ˆë‹¤.",
    tags: ["ëˆˆ ê±´ê°•", "ë‹¨ë°±ì§ˆ", "ì§€ë°©ì‚°", "ë©´ì—­"],
    detailImage: image4,
  },
  {
    id: 2,
    name: "ë¹„íƒ€ë¯¼",
    price: 26000,
    discount: 0.15,
    image: image2,
    thumbnails: [image2, image1, image3],
    description: "ë¹„íƒ€ë¯¼ì€ ì‹ ì²´ ê¸°ëŠ¥ì„ ì§€ì›í•˜ë©° ì—ë„ˆì§€ë¥¼ ê³µê¸‰í•©ë‹ˆë‹¤.",
    tags: ["ë¹„íƒ€ë¯¼ A", "ë¹„íƒ€ë¯¼ C", "ë©´ì—­"],
    detailImage: image4,
  },
  {
    id: 3,
    name: "í™ì‚¼",
    price: 41500,
    discount: 0.2,
    image: image1,
    thumbnails: [image1, image3, image2],
    description: "í™ì‚¼ì€ ë©´ì—­ë ¥ì„ ì¦ì§„ì‹œí‚¤ê³  í”¼ë¡œ íšŒë³µì— ë„ì›€ì„ ì¤ë‹ˆë‹¤.",
    tags: ["ë©´ì—­", "í•­ì‚°í™”", "í”¼ë¡œ íšŒë³µ"],
    detailImage: image4,
  },
];

// ìƒ˜í”Œ ë¦¬ë·° ë°ì´í„°
const initialReviews = [
  { id: 1, title: "ê±´ê°•í•˜ë©´ ìš¸ë¦¬ëŠ” ì‚¬ì´ë Œ", content: "ìš°ë¦¬ ì•„ì´ê°€ ì°¸ ì¢‹ì•„í•´ìš”.", rating: 4, date: "2025.02.10", likes: 17, images: [] },
  { id: 2, title: "ê±´ê°•ë§¨", content: "ë§¤ì¼ ë¨¹ìœ¼ë‹ˆ íš¨ê³¼ê°€ ì¢‹ì€ ê²ƒ ê°™ì•„ìš”.", rating: 5, date: "2025.02.08", likes: 25, images: [] },
];

const ProductDetail = () => {
  const { id } = useParams();
  const product = products.find((p) => p.id === parseInt(id));
  const [mainImage, setMainImage] = useState("");
  const [activeTab, setActiveTab] = useState("real-product-details");
  const chartRef = useRef(null);
  const chartInstance = useRef(null);
  const [reviews, setReviews] = useState(initialReviews); // ğŸ“Œ ë¦¬ë·° ìƒíƒœ ì¶”ê°€
  const [showReviewModal, setShowReviewModal] = useState(false); // ğŸ“Œ ëª¨ë‹¬ ìƒíƒœ ì¶”ê°€

  useEffect(() => {
    if (product) {
      setMainImage(product.image);
    }
  }, [product]);

  useEffect(() => {
    if (activeTab !== "real-product-review") return; // ğŸš€ ë¦¬ë·° íƒ­ì´ ì•„ë‹ ê²½ìš° ì‹¤í–‰í•˜ì§€ ì•ŠìŒ.

    if (!chartRef.current) return;

    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    const ctx = chartRef.current.getContext("2d");
    chartInstance.current = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["1ì ", "2ì ", "3ì ", "4ì ", "5ì "],
        datasets: [
          {
            label: "ë¦¬ë·° ê°œìˆ˜",
            data: [2, 5, 7, 3, 3], // ì˜ˆì œ ë°ì´í„°
            backgroundColor: "rgba(75, 192, 192, 0.7)",
            borderColor: "rgba(75, 192, 192, 1)",
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 } },
        },
      },
    });

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [activeTab]);

  if (!product) return <h2 className="text-center mt-5">ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h2>;

  const discountedPrice = product.price - product.price * product.discount;

  // ğŸ“Œ ë¦¬ë·° ì¶”ê°€ í•¨ìˆ˜
  const handleAddReview = (newReview) => {
    setReviews([...reviews, newReview]);
  };

  return (
    <Container style={{ paddingTop: "115.19px" }}>
      <Container className="container-fluid product-detail text-center">
        <h1 className="fw-bold mb-4 text-pilllaw">ìƒí’ˆ ìƒì„¸ì •ë³´</h1>
        <hr className="text-pilllaw" />

        {/* ë¦¬ë·° ì‘ì„± ëª¨ë‹¬ */}
        <ReviewForm show={showReviewModal} handleClose={() => setShowReviewModal(false)} addReview={handleAddReview} />

        {/* ë¦¬ë·° ì‘ì„± ë²„íŠ¼ */}
        <Button
          variant="pilllaw-secondary"
          className="btn-sm fw-bold btn-pilllaw fs-14"
          onClick={() => setShowReviewModal(true)}
        >
          ë¦¬ë·° ì‘ì„±í•˜ê¸° <FontAwesomeIcon icon={faStar} />
        </Button>

        {/* ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ */}
        <Row className="mt-5">
          {reviews.map((review) => (
            <div key={review.id} className="row border border-1 pt-4 pb-3 mx-3 fs-12 mt-2">
              {/* ë¦¬ë·° ì´ë¯¸ì§€ */}
              <Col xs={2} className="d-flex align-items-center">
                {review.images && review.images.length > 0 ? (
                  <img className="img-fluid w-75 pilllaw-product-image" src={review.images[0]} alt="ë¦¬ë·° ì´ë¯¸ì§€" />
                ) : (
                  <img className="img-fluid w-75 pilllaw-product-image" src={mainImage} alt="ê¸°ë³¸ ì´ë¯¸ì§€" />
                )}
              </Col>

              {/* ë¦¬ë·° ë³¸ë¬¸ */}
              <Col xs={6}>
                <Row className="text-start">
                  <span className="fw-bold">{review.title}</span>
                </Row>
                <Row className="text-start mt-2">
                  <span dangerouslySetInnerHTML={{ __html: review.content }} />
                </Row>
              </Col>

              {/* ì‘ì„±ì¼ */}
              <Col xs={2} className="text-center">
                <span>ì‘ì„±ì¼: {review.date}</span>
              </Col>

              {/* ë³„ì  */}
              <Col xs={2} className="text-center">
                <span className="fw-bold">ë³„ì : </span>
                {Array.from({ length: review.rating }).map((_, index) => (
                  <FontAwesomeIcon key={index} icon={faStar} className="text-warning" />
                ))}
                ({review.rating}ì )
              </Col>
            </div>
          ))}
        </Row>
      </Container>
    </Container>
  );
};

export default ProductDetail;
